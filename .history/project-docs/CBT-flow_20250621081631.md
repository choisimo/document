# CBT Diary: ì „ì²´ ê¸°ëŠ¥ë³„ ë¹„ì¦ˆë‹ˆìŠ¤ íë¦„ë„  

ë³¸ ë¬¸ì„œëŠ” ì‚¬ìš©ìê°€ React-Native í´ë¼ì´ì–¸íŠ¸ì—ì„œ íŠ¹ì • ì‘ì—…ì„ ìˆ˜í–‰í–ˆì„ ë•Œ, Auth-server(Spring Boot), ai-server(Python), ê·¸ë¦¬ê³  ë°ì´í„°ë² ì´ìŠ¤(MariaDB, Redis) ê°„ì— ë°ì´í„°ê°€ ì–´ë–»ê²Œ íë¥´ëŠ”ì§€ ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨ìœ¼ë¡œ ì‹œê°í™”í•œ ê²ƒì…ë‹ˆë‹¤.

> **ì°¸ê³ **: í˜„ì¬ í”„ë¡œì íŠ¸ì˜ ì£¼ ë°ì´í„°ë² ì´ìŠ¤ëŠ” MariaDBì…ë‹ˆë‹¤. ì¼ê¸°, ì‚¬ìš©ì ì •ë³´, AI ë¶„ì„ ê²°ê³¼ ë“± í•µì‹¬ ë°ì´í„°ëŠ” ëª¨ë‘ MariaDBì— ì €ì¥ ë° ê´€ë¦¬ë©ë‹ˆë‹¤.

## 1. ì‚¬ìš©ì ì¸ì¦ (Authentication)

### 1.1. ì‚¬ìš©ì íšŒì›ê°€ì…

ì‚¬ìš©ìê°€ ì•±ì—ì„œ ì´ë©”ì¼, ë¹„ë°€ë²ˆí˜¸, ì´ë¦„ ë“± ì •ë³´ë¥¼ ì…ë ¥í•˜ê³  'íšŒì›ê°€ì…'ì„ ìš”ì²­í–ˆì„ ë•Œì˜ íë¦„ì…ë‹ˆë‹¤.

```mermaid
sequenceDiagram
    participant Client as CBT-front (React-Native)
    participant AuthServer as Auth-server (Spring Boot)
    participant Database as MariaDB

    Client->>AuthServer: 1. íšŒì›ê°€ì… ìš”ì²­ (POST /api/users/join) <br> {email, password, name}
    activate AuthServer

    AuthServer->>Database: 2. ì´ë©”ì¼ ì¤‘ë³µ í™•ì¸ (SELECT)
    activate Database
    Database-->>AuthServer: 3. ì¤‘ë³µ ì—¬ë¶€ ë°˜í™˜
    deactivate Database

    alt ì´ë©”ì¼ ì‚¬ìš© ê°€ëŠ¥
        AuthServer->>AuthServer: 4. ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™” (BCrypt)
        AuthServer->>Database: 5. ì‚¬ìš©ì ì •ë³´ ì €ì¥ (INSERT INTO users)
        activate Database
        Database-->>AuthServer: 6. ì €ì¥ ì™„ë£Œ
        deactivate Database

        AuthServer-->>Client: 7. íšŒì›ê°€ì… ì„±ê³µ ì‘ë‹µ (201 Created)
    else ì´ë©”ì¼ ì¤‘ë³µ
        AuthServer-->>Client: 7. íšŒì›ê°€ì… ì‹¤íŒ¨ ì‘ë‹µ (409 Conflict)
    end
    deactivate AuthServer
```

### 1.2. ì‚¬ìš©ì ë¡œê·¸ì¸ ë° í† í° ê´€ë¦¬

ì‚¬ìš©ìê°€ ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¡œ 'ë¡œê·¸ì¸'ì„ ìš”ì²­í–ˆì„ ë•Œì˜ ì¸ì¦ ë° í† í° ë°œê¸‰/ì €ì¥ íë¦„ì…ë‹ˆë‹¤.

```mermaid
sequenceDiagram
    participant Client as CBT-front (React-Native)
    participant AuthServer as Auth-server (Spring Boot)
    participant Database as MariaDB
    participant Cache as Redis

    Client->>AuthServer: 1. ë¡œê·¸ì¸ ìš”ì²­ (POST /api/auth/login) <br> {email, password}
    activate AuthServer

    AuthServer->>Database: 2. ì‚¬ìš©ì ì •ë³´ ë° ì•”í˜¸í™”ëœ ë¹„ë°€ë²ˆí˜¸ ì¡°íšŒ (SELECT)
    activate Database
    Database-->>AuthServer: 3. ì‚¬ìš©ì ì •ë³´ ë°˜í™˜
    deactivate Database

    AuthServer->>AuthServer: 4. ë¹„ë°€ë²ˆí˜¸ ì¼ì¹˜ ì—¬ë¶€ í™•ì¸

    alt ì¸ì¦ ì„±ê³µ
        AuthServer->>AuthServer: 5. Access & Refresh í† í° ìƒì„± (JWT)

        AuthServer->>Cache: 6. Refresh í† í° ì €ì¥ (SET user_email:token)
        activate Cache
        Cache-->>AuthServer: 7. ì €ì¥ ì™„ë£Œ
        deactivate Cache

        AuthServer-->>Client: 8. í† í° ë° ì‚¬ìš©ì ì •ë³´ ì‘ë‹µ <br> {accessToken, refreshToken, user}
        deactivate AuthServer

        Client->>Client: 9. ê¸°ê¸°ì— í† í° ë° ì‚¬ìš©ì ì •ë³´ ì €ì¥ (AsyncStorage)

    else ì¸ì¦ ì‹¤íŒ¨
        AuthServer-->>Client: 8. ë¡œê·¸ì¸ ì‹¤íŒ¨ ì‘ë‹µ (401 Unauthorized)
        deactivate AuthServer
    end
```

## 2. ì¼ê¸° ê´€ë¦¬ (Diary Management)

### 2.1. ì¼ê¸° ì‘ì„± ë° AI ê°ì • ë¶„ì„

ì‚¬ìš©ìê°€ ì¼ê¸°ë¥¼ ì‘ì„±í•˜ê³  'ì €ì¥'ì„ ìš”ì²­í–ˆì„ ë•Œ, ì¼ê¸° ì €ì¥ê³¼ AI ë¶„ì„ì´ í•¨ê»˜ ì´ë£¨ì–´ì§€ëŠ” ë¹„ë™ê¸° íë¦„ì…ë‹ˆë‹¤.

```mermaid
sequenceDiagram
    participant Client as CBT-front (React-Native)
    participant AuthServer as Auth-server (Spring Boot)
    participant AiServer as ai-server (Python/FastAPI)
    participant OpenAIApi as ì™¸ë¶€ LLM (GPT)
    participant Database as MariaDB

    Client->>AuthServer: 1. ì¼ê¸° ì €ì¥ ìš”ì²­ (POST /api/diary) <br> {title, content, weather}
    activate AuthServer

    AuthServer->>Database: 2. ì¼ê¸° ì •ë³´ ì €ì¥ (INSERT INTO diary)
    activate Database
    Database-->>AuthServer: 3. ì €ì¥ëœ ì¼ê¸°(diary_id) ë°˜í™˜
    deactivate Database

    AuthServer-->>Client: 4. ì¼ê¸° ì €ì¥ ì„±ê³µ ì‘ë‹µ (201 Created)

    par AI ë¶„ì„ (ë¹„ë™ê¸° ì²˜ë¦¬)
        AuthServer->>AiServer: 5. ì¼ê¸° ë¶„ì„ ìš”ì²­ (POST /analyze) <br> {text: diary.content}
        activate AiServer

        AiServer->>OpenAIApi: 6. í”„ë¡¬í”„íŠ¸ ê¸°ë°˜ ë¶„ì„ ìš”ì²­
        activate OpenAIApi
        OpenAIApi-->>AiServer: 7. ë¶„ì„ ê²°ê³¼ ë°˜í™˜
        deactivate OpenAIApi

        AiServer->>AiServer: 8. ê²°ê³¼ í¬ë§·íŒ… (JSON)
        AiServer-->>AuthServer: 9. ë¶„ì„ ê²°ê³¼ JSON ì‘ë‹µ
        deactivate AiServer

        AuthServer->>Database: 10. ë¶„ì„ ê²°ê³¼ ì €ì¥ (INSERT INTO report)
        activate Database
        Database-->>AuthServer: 11. ì €ì¥ëœ ë¶„ì„(report_id) ë°˜í™˜
        deactivate Database

        AuthServer->>Database: 12. ì¼ê¸°ì™€ ë¶„ì„ ê²°ê³¼ ì—°ê²° <br> (UPDATE diary SET report_id = ?)
    end
    deactivate AuthServer
```

### 2.2. íŠ¹ì • ë‚ ì§œì˜ ì¼ê¸° ëª©ë¡ ì¡°íšŒ

ì‚¬ìš©ìê°€ ìº˜ë¦°ë”ì—ì„œ íŠ¹ì • ë‚ ì§œë¥¼ ì„ íƒí–ˆì„ ë•Œ, í•´ë‹¹ ë‚ ì§œì— ì‘ì„±ëœ ëª¨ë“  ì¼ê¸°ì˜ ìš”ì•½ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” íë¦„ì…ë‹ˆë‹¤.

```mermaid
sequenceDiagram
    participant Client as CBT-front (React-Native)
    participant AuthServer as Auth-server (Spring Boot)
    participant Database as MariaDB

    Client->>AuthServer: 1. íŠ¹ì • ë‚ ì§œ ì¼ê¸° ëª©ë¡ ìš”ì²­ (GET /api/diary/calendar?date=YYYY-MM-DD)
    activate AuthServer

    AuthServer->>Database: 2. í•´ë‹¹ ë‚ ì§œì˜ ì¼ê¸° ëª©ë¡ ì¡°íšŒ (SELECT ... WHERE user_id = ? AND created_at LIKE 'YYYY-MM-DD%')
    activate Database
    Database-->>AuthServer: 3. ì¼ê¸° ëª©ë¡(id, title, emotion ë“±) ë°˜í™˜
    deactivate Database

    AuthServer-->>Client: 4. ì¼ê¸° ëª©ë¡ ë°ì´í„° ì‘ë‹µ
    deactivate AuthServer
```

### 2.3. ì¼ê¸° ìƒì„¸ ë‚´ìš© ì¡°íšŒ

ì‚¬ìš©ìê°€ ëª©ë¡ì—ì„œ íŠ¹ì • ì¼ê¸°ë¥¼ ì„ íƒí–ˆì„ ë•Œ, ì¼ê¸°ì˜ ì „ì²´ ë‚´ìš©ê³¼ AI ë¶„ì„ ê²°ê³¼ë¥¼ í•¨ê»˜ ì¡°íšŒí•˜ëŠ” íë¦„ì…ë‹ˆë‹¤.

```mermaid
sequenceDiagram
    participant Client as CBT-front (React-Native)
    participant AuthServer as Auth-server (Spring Boot)
    participant Database as MariaDB

    Client->>AuthServer: 1. ì¼ê¸° ìƒì„¸ ì¡°íšŒ ìš”ì²­ (GET /api/diary/{diaryId})
    activate AuthServer

    AuthServer->>Database: 2. ì¼ê¸° ë° ì—°ê´€ëœ ë¶„ì„ ë¦¬í¬íŠ¸ ì¡°íšŒ <br> (SELECT * FROM diary d LEFT JOIN report r ON d.report_id = r.id WHERE d.id = ?)
    activate Database
    Database-->>AuthServer: 3. ì¼ê¸° ë° ë¶„ì„ ë°ì´í„° ë°˜í™˜
    deactivate Database

    AuthServer-->>Client: 4. ìƒì„¸ ë°ì´í„°(ì¼ê¸°+ë¶„ì„) ì‘ë‹µ
    deactivate AuthServer
```

### 2.4. ì¼ê¸° ìˆ˜ì •

ì‚¬ìš©ìê°€ ê¸°ì¡´ì— ì‘ì„±í–ˆë˜ ì¼ê¸°ì˜ ë‚´ìš©ì„ ìˆ˜ì •í•˜ê³  'ì €ì¥'ì„ ìš”ì²­í–ˆì„ ë•Œì˜ íë¦„ì…ë‹ˆë‹¤. (í˜„ì¬ ë¡œì§ì—ì„œëŠ” ìˆ˜ì • ì‹œ AI ì¬ë¶„ì„ì€ ìˆ˜í–‰ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.)

```mermaid
sequenceDiagram
    participant Client as CBT-front (React-Native)
    participant AuthServer as Auth-server (Spring Boot)
    participant Database as MariaDB

    Client->>AuthServer: 1. ì¼ê¸° ìˆ˜ì • ìš”ì²­ (PUT /api/diary/{diaryId}) <br> {title, content, weather}
    activate AuthServer

    AuthServer->>Database: 2. ìˆ˜ì •í•  ì¼ê¸° ì¡°íšŒ (ì†Œìœ ì í™•ì¸)
    activate Database
    Database-->>AuthServer: 3. ì¼ê¸° ì •ë³´ ë°˜í™˜
    deactivate Database

    alt ì†Œìœ ì ì¼ì¹˜
        AuthServer->>Database: 4. ì¼ê¸° ë‚´ìš© ì—…ë°ì´íŠ¸ (UPDATE diary SET ...)
        activate Database
        Database-->>AuthServer: 5. ì—…ë°ì´íŠ¸ ì™„ë£Œ
        deactivate Database

        AuthServer-->>Client: 6. ìˆ˜ì • ì„±ê³µ ì‘ë‹µ (200 OK)
    else ì†Œìœ ì ë¶ˆì¼ì¹˜ ë˜ëŠ” ì¼ê¸° ì—†ìŒ
        AuthServer-->>Client: 6. ì‹¤íŒ¨ ì‘ë‹µ (403 Forbidden / 404 Not Found)
    end
    deactivate AuthServer
```

### 2.5. ì¼ê¸° ì‚­ì œ

ì‚¬ìš©ìê°€ íŠ¹ì • ì¼ê¸°ë¥¼ ì‚­ì œí•˜ëŠ” íë¦„ì…ë‹ˆë‹¤.

```mermaid
sequenceDiagram
    participant Client as CBT-front (React-Native)
    participant AuthServer as Auth-server (Spring Boot)
    participant Database as MariaDB

    Client->>AuthServer: 1. ì¼ê¸° ì‚­ì œ ìš”ì²­ (DELETE /api/diary/{diaryId})
    activate AuthServer

    AuthServer->>Database: 2. ì‚­ì œí•  ì¼ê¸° ì¡°íšŒ (ì†Œìœ ì í™•ì¸)
    activate Database
    Database-->>AuthServer: 3. ì¼ê¸° ì •ë³´ ë°˜í™˜
    deactivate Database

    alt ì†Œìœ ì ì¼ì¹˜
        AuthServer->>Database: 4. ì¼ê¸° ë° ì—°ê´€ëœ ë¦¬í¬íŠ¸ ì‚­ì œ (DELETE)
        note right of Database: Cascade ì„¤ì • ë˜ëŠ”<br>ì„œë¹„ìŠ¤ ë¡œì§ìœ¼ë¡œ Report í•¨ê»˜ ì‚­ì œ
        activate Database
        Database-->>AuthServer: 5. ì‚­ì œ ì™„ë£Œ
        deactivate Database

        AuthServer-->>Client: 6. ì‚­ì œ ì„±ê³µ ì‘ë‹µ (204 No Content)
    else ì†Œìœ ì ë¶ˆì¼ì¹˜ ë˜ëŠ” ì¼ê¸° ì—†ìŒ
        AuthServer-->>Client: 6. ì‹¤íŒ¨ ì‘ë‹µ (403 Forbidden / 404 Not Found)
    end
    deactivate AuthServer
```

---

## ğŸ“Š í”„ë¡œì íŠ¸ ì•„í‚¤í…ì²˜ ê°œìš”

```mermaid
graph TB
    subgraph "Client Layer"
        A[CBT-front<br/>React-Native]
    end
    
    subgraph "Server Layer"
        B[Auth-server<br/>Spring Boot]
        C[ai-server<br/>Python/FastAPI]
    end
    
    subgraph "Database Layer"
        D[(MariaDB<br/>Core Data)]
        E[(Redis<br/>Cache)]
    end
    
    subgraph "External Services"
        F[OpenAI API<br/>GPT Models]
    end
    
    A -->|API Requests| B
    B -->|AI Analysis| C
    C -->|LLM Requests| F
    B -->|Data Storage| D
    B -->|Token Cache| E
    C -->|Analysis Results| B
```

## ğŸ”„ ì „ì²´ ì‹œìŠ¤í…œ í”Œë¡œìš°

```mermaid
flowchart LR
    Start([ì‚¬ìš©ì ì•± ì‹¤í–‰]) --> Auth{ì¸ì¦ ìƒíƒœ}
    Auth -->|ë¡œê·¸ì¸ë¨| Main[ë©”ì¸ í™”ë©´]
    Auth -->|ë¯¸ë¡œê·¸ì¸| Login[ë¡œê·¸ì¸/íšŒì›ê°€ì…]
    
    Login --> Main
    Main --> Diary[ì¼ê¸° ì‘ì„±]
    Main --> Calendar[ìº˜ë¦°ë” ì¡°íšŒ]
    Main --> Analysis[ë¶„ì„ ê²°ê³¼ ì¡°íšŒ]
    
    Diary --> AI[AI ê°ì • ë¶„ì„]
    AI --> Save[ë°ì´í„° ì €ì¥]
    Save --> Main
    
    Calendar --> DiaryList[ì¼ê¸° ëª©ë¡]
    DiaryList --> DiaryDetail[ì¼ê¸° ìƒì„¸]
    DiaryDetail --> Edit[í¸ì§‘/ì‚­ì œ]
    Edit --> Main
    
    Analysis --> Report[ë¦¬í¬íŠ¸ ìƒì„±]
    Report --> Main
```

## âš¡ ì£¼ìš” ê¸°ëŠ¥ë³„ ì²˜ë¦¬ ì‹œê°„

| ê¸°ëŠ¥ | ì˜ˆìƒ ì²˜ë¦¬ ì‹œê°„ | ë¹„ê³  |
|------|----------------|------|
| íšŒì›ê°€ì… | 200-500ms | ì´ë©”ì¼ ì¤‘ë³µ ì²´í¬ í¬í•¨ |
| ë¡œê·¸ì¸ | 150-300ms | JWT í† í° ìƒì„± |
| ì¼ê¸° ì €ì¥ | 100-200ms | AI ë¶„ì„ì€ ë¹„ë™ê¸° |
| AI ê°ì • ë¶„ì„ | 2-5ì´ˆ | OpenAI API ì‘ë‹µ ì‹œê°„ |
| ì¼ê¸° ëª©ë¡ ì¡°íšŒ | 50-150ms | í˜ì´ì§• ì ìš© ì‹œ |
| ì¼ê¸° ìƒì„¸ ì¡°íšŒ | 100-200ms | ì¡°ì¸ ì¿¼ë¦¬ í¬í•¨ |

## ğŸ› ï¸ ê¸°ìˆ  ìŠ¤íƒ ìƒì„¸

### Frontend
- **React Native**: í¬ë¡œìŠ¤ í”Œë«í¼ ëª¨ë°”ì¼ ì•±
- **AsyncStorage**: ë¡œì»¬ ë°ì´í„° ì €ì¥ (í† í°, ì‚¬ìš©ì ì„¤ì •)

### Backend
- **Spring Boot**: RESTful API ì„œë²„
- **Spring Security**: ì¸ì¦/ì¸ê°€ ì²˜ë¦¬
- **JWT**: í† í° ê¸°ë°˜ ì¸ì¦

### AI Server
- **FastAPI**: ë¹ ë¥¸ API ì‘ë‹µì„ ìœ„í•œ Python ì›¹ í”„ë ˆì„ì›Œí¬
- **OpenAI API**: GPT ëª¨ë¸ì„ í™œìš©í•œ ê°ì • ë¶„ì„

### Database
- **MariaDB**: ì£¼ ë°ì´í„°ë² ì´ìŠ¤ (ì‚¬ìš©ì, ì¼ê¸°, ë¶„ì„ ê²°ê³¼)
- **Redis**: ìºì‹œ ë° ì„¸ì…˜ ê´€ë¦¬

---

*ì´ ë¬¸ì„œëŠ” CBT Diary í”„ë¡œì íŠ¸ì˜ ì „ì²´ì ì¸ ë°ì´í„° íë¦„ì„ ì´í•´í•˜ëŠ” ë° ë„ì›€ì´ ë˜ë„ë¡ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ê° ë‹¤ì´ì–´ê·¸ë¨ì€ ì‹¤ì œ API ì—”ë“œí¬ì¸íŠ¸ì™€ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•©ë‹ˆë‹¤.*
